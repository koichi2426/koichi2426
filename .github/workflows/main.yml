name: 🚀 GitHub Metrics Generator

on:
  # 🕐 自動実行: 毎日午前2時 (JST)
  schedule:
    - cron: "0 17 * * *"  # UTC 17:00 = JST 02:00
  
  # ⚡ 手動実行可能
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate all metrics'
        required: false
        default: 'false'
        type: boolean
  
  # 📝 mainブランチへのプッシュ時に実行
  push:
    branches:
      - main
    paths:
      - '.github/workflows/metrics.yml'
      - 'README.md'

env:
  METRICS_VERSION: latest

jobs:
  generate-metrics:
    name: 📊 Generate GitHub Metrics
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    strategy:
      matrix:
        metric_type: [base, languages, achievements]
    
    steps:
      - name: 🔧 Setup Environment
        run: |
          echo "Starting metrics generation for: ${{ matrix.metric_type }}"
          echo "Timestamp: $(date)"
      
      - name: 📈 Base Metrics & Activity
        if: matrix.metric_type == 'base'
        uses: lowlighter/metrics@latest
        with:
          filename: output/metrics.base.svg
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          base: header, activity, community, repositories, metadata
          base_indepth: yes
          base_hireable: yes
          base_skip: yes
          config_timezone: Asia/Tokyo
          config_display: large
          config_animations: yes
          optimize: css, xml, svg
          experimental_features: --optimize-svg
      
      - name: 🎯 Language Analytics & Deep Insights
        if: matrix.metric_type == 'languages'
        uses: lowlighter/metrics@latest
        with:
          filename: output/languages.detailed.svg
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          base: ""
          config_timezone: Asia/Tokyo
          config_display: large
          config_animations: yes
          repositories_skipped: |
            chatbot-ui, 
            gitHub-readme-stats-clone, 
            PL0-compiler,
            archived-*
          plugin_languages: yes
          plugin_languages_ignored: >-
            tex, less, qmake, lex, gnuplot, makefile, dockerfile, 
            batchfile, powershell, shell
          plugin_languages_details: bytes-size, percentage, lines
          plugin_languages_sections: most-used, recently-used
          plugin_languages_colors: github
          plugin_languages_limit: 10
          plugin_languages_threshold: 2%
          plugin_followup: yes
          plugin_followup_sections: repositories, user
          plugin_followup_indepth: yes
          plugin_activity: yes
          plugin_activity_limit: 8
          plugin_activity_days: 30
          plugin_activity_filter: all
          plugin_activity_visibility: all
          plugin_activity_timestamps: yes
          optimize: css, xml, svg
      
      - name: 🏆 Achievement Showcase
        if: matrix.metric_type == 'achievements'
        uses: lowlighter/metrics@latest
        with:
          filename: output/achievements.elite.svg
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          base: ""
          config_timezone: Asia/Tokyo
          config_display: large
          config_animations: yes
          plugin_achievements: yes
          plugin_achievements_only: >-
            polyglot, stargazer, sponsor, deployer, member, maintainer, 
            developer, scripter, packager, explorer, infographile, manager,
            contributor, committer, reviewer, influencer, automator
          plugin_achievements_display: detailed
          plugin_achievements_threshold: C
          plugin_achievements_secrets: yes
          plugin_achievements_limit: 20
          plugin_notable: yes
          plugin_notable_filter: stars:>50
          plugin_notable_repositories: yes
          plugin_notable_indepth: yes
          plugin_habits: yes
          plugin_habits_charts: yes
          plugin_habits_charts_type: chartist
          plugin_habits_days: 30
          plugin_habits_facts: yes
          plugin_habits_from: 200
          optimize: css, xml, svg
      
      - name: 🎉 Completion Status
        run: |
          echo "✅ Successfully generated ${{ matrix.metric_type }} metrics!"
          echo "📅 Generated at: $(date)"
          echo "🔗 Check your repository for the updated metrics!"

  notify-completion:
    name: 🔔 Notify Completion
    needs: generate-metrics
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: 📋 Summary Report
        run: |
          echo "🚀 GitHub Metrics Generation Complete!"
          echo "=================================="
          echo "✅ Base metrics: Generated"
          echo "✅ Language analytics: Generated"  
          echo "✅ Achievements: Generated"
          echo "📊 All metrics are now available in /output directory"
          echo "🌟 Your GitHub profile just got more awesome!"
